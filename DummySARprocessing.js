/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var openWater = /* color: #f51902 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([2.4403837653947402, -58.71769824008986]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-75.43070998460524, -63.54434769200581]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.84477248460523, -63.465928645854994]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-43.96586623460524, -59.17109164097489]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-108.70459102265708, -65.77597610176304]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.56787227265708, -66.06286260085865]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-50.345216022657084, -56.62028798169023]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-22.220216022657088, -58.04330367668444]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-12.376466022657086, -57.856744456498795]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([4.146971477342913, -59.67912102217812]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-55.970216022657084, -59.59026165045557]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-77.23974727265708, -64.67116147426353]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-98.86084102265708, -66.69670176164257]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-73.19677852265708, -65.26613847638473]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-40.853028522657084, -57.00515860628631]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-16.243653522657088, -59.41183622809011]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-1.4780285226570866, -58.8708773284279]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([10.826658977342912, -63.04525761562259]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([0.8071277273429134, -59.59026165045557]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-48.587403522657084, -57.856744456498795]),
            {
              "label": 3,
              "backscatter": 0,
              "system:index": "19"
            })]),
    seaIce = /* color: #063cff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-45.72367873460524, -72.8067912070693]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-28.67289748460524, -72.09128718067974]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-42.33988967210524, -68.97866027958244]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-44.27348342210524, -70.44099544040874]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-85.05473342210523, -71.43117080220934]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-102.10551467210523, -70.67502940881516]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-105.62113967210523, -71.52888063815429]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-91.73442092210523, -69.55425620479322]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-45.37211623460524, -74.03508530793891]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-53.41410842210524, -74.9284013011833]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-49.37113967210524, -68.22517343751527]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([15.045408977342912, -67.04195577590095]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-10.618653522657086, -62.40081308474178]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-20.638184772657088, -63.675756915773896]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-15.892091022657086, -66.627064940999]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-21.165528522657088, -70.70739930843098]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-42.962403522657084, -63.283316902569425]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.68896602265708, -68.76048149586885]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-112.57177852265708, -68.50430064251718]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-34.524903522657084, -75.12400943895511]),
            {
              "label": 2,
              "backscatter": 0,
              "system:index": "19"
            })]),
    iceberg = /* color: #f3f704 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-110.03476943640933, -73.785457204899]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-108.71641006140933, -73.94421958029879]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-109.50742568640933, -73.90771697095906]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-108.84824599890933, -74.06531356325313]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-105.02500381140933, -73.05833520585207]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-104.89316787390933, -73.09670966952619]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-47.061136623909334, -76.22469341555662]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-46.885355373909334, -76.27691625937197]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.963480373909334, -75.87510311401789]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-40.996683498909334, -75.98194777488878]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-40.293558498909334, -75.87510311401789]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.172464748909334, -75.51682587078727]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-109.80322383515708, -74.01364882167643]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-105.40869258515708, -74.38458090201368]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.53870146019043, -75.53356073236174]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.01135771019043, -75.61020803684394]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.62659208519043, -75.77311598027026]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-41.53870146019043, -75.95556194978998]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-40.39612333519043, -75.9981561338007]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-40.92346708519043, -75.64293506421222]),
            {
              "label": 1,
              "backscatter": 0,
              "system:index": "19"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Define antarctic latitudes as area of interest
var aoi = ee.Geometry.BBox(-180, -90, 180, -55);

// Define time period (window of a couple of weeks as a simple test)
var startDate = '2020-06-01';
var endDate = '2020-06-16';

// Select Sentinel 1 EW (extra wide swath) images in area of interest and time period
// best data availability for extra wide swath mode
// inconsistent backscatter between scenes (striping) could be exacerbated by high incidence angles in EW mode?
var s1 = ee.ImageCollection('COPERNICUS/S1_GRD').
  filterMetadata('instrumentMode', 'equals', 'EW').
  filterBounds(aoi).
  filterDate(startDate, endDate);

var cnt = ee.FeatureCollection(s1).
  // choose a specific orbit so geometry is consistent,
  // data coverage best for ascending geometry
  // could later attempt to merge in descending geometry scenes if backscatter can be made consistent enough
  filterMetadata('orbitProperties_pass', 'equals', 'ASCENDING').
  reduceToImage(['system:index'], ee.Reducer.count());

// Count the number of scenes available in the selected time interval
var upper = cnt.reduceRegion(
  {reducer: ee.Reducer.max(), geometry: aoi, scale: 1000, bestEffort: true}
);
print('Max count:', upper.get('count'));
// Define a red to green pseudo color palette for visualisation
var red2green = ['a50026', 'd73027', 'f46d43', 'fdae61', 'fee08b', 'ffffbf',
  'd9ef8b', 'a6d96a', '66bd63', '1a9850', '006837'];
// Add the scene count to the map
Map.addLayer(cnt.updateMask(cnt.gt(0)).clip(aoi),
  {min: 1, max: upper.get('count').getInfo(), palette: red2green}, 'Number of scenes');

// Calculate mean backscatter intensity for HH polarisation
// pre-processing for orbit correction, border/thermal noise removal, radiometric calibration
// and terrain correction already applied to this data product.
// Scene edge artefacts still quite prominent - need to improve pre-processing to 
// improve scene to scene consistency (can be affected by wind/sea state etc.).
var avBSintRaw = s1.select('HH').mean();
Map.addLayer(avBSintRaw, {min: -20, max: 2}, 'average HH backscatter intensity');

// Define a boxcar or low-pass kernel that will be used to smooth the backscatter data
var boxcar = ee.Kernel.square({
  radius: 3, units: 'pixels', normalize: true
});
// Smooth the image by convolving with the boxcar kernel.
// this is to reduce noise in the segmented ice type image but this technique
// is quite crude and should be replaced by more effecient speckle noise reduction later
var avBSint = avBSintRaw.convolve(boxcar);
Map.addLayer(avBSint, {min: -20, max: 2}, 'smoothed backscatter intensity');

// Mask out land areas
// radar backscatter from land areas can be high and we want to focus on open water, sea ice, iceberg
var DEM = ee.Image('CPOM/CryoSat2/ANTARCTICA_DEM'); //load an available DEM
var elevation = DEM.select('elevation'); //extract the elevation channel to its own image
elevation = elevation.unmask(1); //reset existing pixel mask
var land = elevation.lte(1); //areas higher than 1m will be masked out
// uncomment next line to plot the land/sea mask
//Map.addLayer(land,{palette:['brown', 'green'],min:-1, max:1},'Land mask');
var MaskedBS = avBSint.updateMask(land); //mask out the backscatter image areas on land
// uncomment next line to plot the masked backscatter
//Map.addLayer(MaskedBS, {min: -20, max: 2}, 'masked HH backscatter');

// collate training data - need to merge the imported variables
var merged = openWater.merge(seaIce).merge(iceberg); //merge the different classes of training data
print(merged)
var trainDat = avBSint.sampleRegions({
  collection: merged,
  properties: ['label'],
  scale: 5
});
print(trainDat)

// Train a simple classifier
// should try with a convolutional neural network approach at a later date
var trainedClassifier = ee.Classifier.smileGradientTreeBoost(3).train({
  features: trainDat,
  classProperty: 'label', //values 
  inputProperties: ["HH"] //HH is horizontal polarisation (both transmit & receive) backscatter 
});

// Get information about the trained classifier.
print('Results of trained classifier', trainedClassifier.explain());

// Classify average backscatter image from the trained classifier.
var imgClassified = MaskedBS.classify(trainedClassifier); //integer labelled single channel image
print('Classified image', imgClassified)
var rgbVis = {palette:['yellow','blue','red'],min: 1, max: 3}; //specify colours to visualise the segmentation
var visualized = imgClassified.visualize(rgbVis); //new image with RGB channels stretched to 0-255 range
//Map.addLayer(imgClassified, {palette:['yellow','blue','red'],min: 1, max: 3}, 'Classified');
Map.addLayer(imgClassified,rgbVis, 'Classified');

// Add a section quantifying the peformance of the classification
// split training data into training and evaluation subsets so the classification can be tested against the evaluation samples
// current classification performance is poor - sea ice with high backscatter labelled as iceberg, open water with high backscatter labelled as sea ice etc.
// better pre-processing needed to enhance scene to scene consistency and contrast between classes
// classifier working on pixel neighbourhoods and able to recognise higher order structure (texture/shape) may also help?

// Futher step/steps to analyse temporal evolution
// track iceberg motion over time
// track ice shelf coastline position over time to monitor surge/calving

// GEOTIFF Export is slow, so limit to a smaller region and don't use highest resolution
// Export the image, using Google pseudomercator CRS, transform, and subregion over Ronne-Filchner ice shelf
print('RGB visualised image',imgClassified)
var projection = imgClassified.projection().getInfo(); //check current projection
print(projection)
// Create a geometry representing the export region.
var exportGeom = ee.Geometry.Rectangle([-70, -79, -15, -54]);//define subregion by West,South,East,North coordinates

// Export RGB visualisation image
Export.image.toDrive({
  image: visualized, //RGB channels stretched to 0-255 range, easier to visualise segmentation result
  description: 'IceTypeRGB_EPSG3857',
  crs: 'EPSG:3857', //export with google pseudomercator projection
  scale: 2000, //resolution, number of meters per pixel
  maxPixels: 1e8,
  fileFormat: 'GeoTIFF',
  region: exportGeom
});

// Export labelled segmentation image i.e. single channel with pixel values 1, 2, 3
Export.image.toDrive({
  image: imgClassified, //integer labelled single channel image, for further processing
  description: 'IceTypeLabelled_EPSG3857',
  crs: 'EPSG:3857',//export with google pseudomercator projection
  scale: 2000, //resolution, number of meters per pixel
  maxPixels: 1e8,
  fileFormat: 'GeoTIFF',
  region: exportGeom
});

